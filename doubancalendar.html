<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <title>Kindleclock</title>

  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no">
  <link rel="shortcut icon" href="favicon.ico" mce_href="/favicon.ico" type="image/x-icon">
  <style>
    @font-face {
      font-family: "LED";
      src: url("js/DS-Digital.TTF");
    }

    /* 公共样式 */

    .body {
      color: #fff;
      background-color: rgba(0, 0, 0, 0.600);
      font-size: 100%;
      margin: 0px;
      width: 100%;
      height: auto;
      background-position: center top;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
    }

    .quote {
      text-align: left;
      margin: 0.3rem;
      margin-left: 1rem;
      margin-right: 1rem;
      font-size: 1.2rem;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      font-style: italic;
    }

    .day {
      font-family: LED;
      width: 100%;
      text-align: center;
      font-weight: 700;
    }

    .time {
      font-family: LED;
      width: 100%;
      text-align: center;
      font-weight: 700;
    }

    .title {
      text-align: left;
      font-weight: 600;
      font-size: 1.5rem;
      margin: 0.3rrem;
    }

    .content {
      text-align: left;
      font-size: 0.8rem;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-box-orient: vertical;
    }

    .mobile_qr {
      text-align: center
    }

    .imagename {
      position: absolute;
      right: 20px;
      top: 20px;
      color: red;
      display: none;
    }

    /* 横屏样式 */
    .mode-landscape .divmain {
      width: 100%;
      height: 100%;
      color: rgb(255, 255, 255);
      z-index: 999;
      position: absolute;
      bottom: 0px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mode-landscape .divleft {
      width: 50%;
      height: 100%;
      float: left;
      vertical-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mode-landscape .divright {
      width: 80%;
    }

    .mode-landscape .image {
      width: 90%;
    }

    .mode-landscape .day {
      font-size: calc(100vw * 600 / 1920);
    }

    .mode-landscape .time {
      font-size: calc(100vw * 500 / 1920);
    }

    /* 竖屏样式 */
    .mode-portrait .backgroundImage {
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      z-index: 2;
      background-position: center;
      background-size: cover;
    }

    .mode-portrait .divbottom {
      width: 100%;
      color: rgb(255, 255, 255);
      background-color: rgba(0, 0, 0, 0.404);
      z-index: 999;
      position: absolute;
      bottom: 0px;
      text-align: center;
    }

    .mode-portrait .bottomleft {
      width: 45%;
      height: 100%;
      float: left;
      vertical-align: center;
    }

    .mode-portrait .bottomright {
      margin-top: 10px;
      height: 100%;
      float: right;
      vertical-align: bottom;
      width: 55%;
    }

    .mode-portrait .image {
      max-width: 600px;
      max-height: 300px;
    }

    .mode-portrait .day {
      font-size: 9rem;
    }

    .mode-portrait .time {
      font-size: 4.4rem;
    }

    /* 布局切换隐藏控制 */
    .mode-landscape .portrait-only {
      display: none !important;
    }

    .mode-portrait .landscape-only {
      display: none !important;
    }
  </style>
</head>

<body id="body" class="body">
  <!-- 横屏布局 -->
  <div id="divmain" class="divmain landscape-only">
    <div id="divleft" class="divleft">
      <img id="image" class="image" alt="Loading..." mode="aspectFill" referrerPolicy="no-referrer">
    </div>
    <div id="divright" class="divright">
      <div id=daytime>
        <div id="day" class="day">19</div>
        <div id="time" class="time"></div>
        <div id="monthday" class="text-left">12月11日</div>
        <div id="lunar" class="text-left"></div>
      </div>
      <div id="content" class="content">
        <div id="title" class="title"></div>
        <div id="rating"></div>
        <div id="year"></div>
        <div id="director"></div>
        <div id="star"></div>
        <div id="quote" class="quote"></div>
        <div id="summary"></div>
        <div id="mobile_qr" class="mobile_qr"></div>
      </div>
    </div>
  </div>

  <!-- 竖屏布局 -->
  <div id="backgroundImage" class="backgroundImage portrait-only" style="background-image: url(); display: block;">
  </div>
  <span id="imagename" class="imagename portrait-only">01-01</span>
  <div id="divbottom" class="divbottom portrait-only">
    <div id="bottomleft" class="bottomleft">
      <div id=daytime-portrait>
        <div id="day-portrait" class="day">19</div>
        <div id="time-portrait" class="time"></div>
      </div>
      <div id="monthday-portrait" class="text-left">01月01日</div>
      <div id="lunar-portrait" class="text-left"></div>
    </div>
    <div id="bottomright" class="bottomright">
      <div id="title-portrait" class="title"></div>
      <div class="content">
        <div id="rating-portrait"></div>
        <div id="year-portrait"></div>
        <div id="director-portrait"></div>
        <div id="star-portrait"></div>
        <div id="quote-portrait" class="quote"></div>
        <div id="summary-portrait"></div>
      </div>
    </div>
    <div id="mobile_qr-portrait" class="mobile_qr"></div>
  </div>

  <script src="https://fastly.jsdelivr.net/gh/adyhwang/kindleclock/js/jquery.min.js"></script>
  <script src="https://fastly.jsdelivr.net/gh/adyhwang/kindleclock/js/jquery-qrcode-0.17.0.min.js"></script>
  <script src="https://fastly.jsdelivr.net/gh/adyhwang/kindleclock/js/ConvertCalendar.js"></script>

  <script>
    (function ($) {
      $.getUrlParam = function (name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
      }
    })(jQuery);

    $(document).ready(function () {
      $(document).mousemove(function () {
        $("#body").css({ cursor: "default" });
      });
    });

    var showtime = false;
    var showmore = false;
    var today = "01-01";
    var jsonfilename = $.getUrlParam("id");
    var rotate = parseInt($.getUrlParam("rotate")) || 0;
    var mode = $.getUrlParam("mode");
    var currentMode = "landscape"; // 默认横屏

    // 初始化模式
    function initMode() {
      // 根据URL参数或屏幕尺寸判断模式
      if (mode === "portrait") {
        currentMode = "portrait";
      } else if (mode === "landscape") {
        currentMode = "landscape";
      } else {
        currentMode = screen.width >= screen.height ? "landscape" : "portrait";
      }

      // 更新样式类
      $("#body").removeClass("mode-landscape mode-portrait").addClass("mode-" + currentMode);
      rotatefunction(); // 应用旋转设置
    }

    // 方向改变处理
    function orientationChange() {
      var newMode = screen.width >= screen.height ? "landscape" : "portrait";
      if (newMode !== currentMode) {
        currentMode = newMode;
        $("#body").removeClass("mode-landscape mode-portrait").addClass("mode-" + currentMode);
        update(); // 刷新显示
      }
    }

    window.addEventListener("orientationchange", orientationChange);

    // 初始化布局设置
    function initLayout() {
      if (currentMode === "landscape") {
        $("#director").css("-webkit-line-clamp", "4");
        $("#star").hide();
        $("#summary").hide();
        $("#mobile_qr").hide();
        $("#quote").hide();
        $("#divmain").css("position", "absolute");
      } else {
        $("#star-portrait").hide();
        $("#time-portrait").hide();
        $("#quote-portrait").hide();
        $("#summary-portrait").hide();
        $("#mobile_qr-portrait").hide();
        $("#bottomright").css("width", "55%");
        $("#divbottom").css("position", "absolute");
      }
    }

    // 旋转功能
    function rotatefunction() {
      if (rotate) {
        if (currentMode === "landscape") {
          $("#divmain").css("transform", "rotate(180deg)");
          $("#divmain").css("-webkit-transform", "rotate(180deg)");
          $("#divmain").css("-moz-transform", "rotate(180deg)");
          $("#divmain").css("-o-transform", "rotate(180deg)");
          $("#divmain").css("-ms-transform", "rotate(180deg)");
        } else {
          $("#body").css("transform", "rotate(180deg)");
          $("#body").css("-webkit-transform", "rotate(180deg)");
          $("#body").css("-moz-transform", "rotate(180deg)");
          $("#body").css("-o-transform", "rotate(180deg)");
          $("#body").css("-ms-transform", "rotate(180deg)");
        }
      } else {
        if (currentMode === "landscape") {
          $("#divmain").css("transform", "");
          $("#divmain").css("-webkit-transform", "");
          $("#divmain").css("-moz-transform", "");
          $("#divmain").css("-o-transform", "");
          $("#divmain").css("-ms-transform", "");
        } else {
          $("#body").css("transform", "");
          $("#body").css("-webkit-transform", "");
          $("#body").css("-moz-transform", "");
          $("#body").css("-o-transform", "");
          $("#body").css("-ms-transform", "");
        }
      }
    }

    // 模式切换
    function modefunction() {
      var newMode = currentMode === "landscape" ? "portrait" : "landscape";
      window.location.href = "doubancalendar.html?id=" + jsonfilename + "&mode=" + newMode + (rotate ? "&rotate=1" : "");
    }

    // 更新时间和日期
    function update() {
      $("#body").css({ cursor: "none" });

      var date = new Date();
      var utc8DiffMinutes = date.getTimezoneOffset() + 480;
      date.setMinutes(date.getMinutes() + utc8DiffMinutes);

      var hour = date.getHours();
      hour = hour < 10 ? "0" + hour : hour;
      var Minutes = date.getMinutes();
      Minutes = Minutes < 10 ? "0" + Minutes : Minutes;
      var timeString = hour + ":" + Minutes;
      var yearString = date.getFullYear();
      var monthString = date.getMonth() + 1;
      monthString = monthString < 10 ? "0" + monthString : monthString;
      var dayString = date.getDate();
      dayString = dayString < 10 ? "0" + dayString : dayString;
      var daysString = dayString.length === 1 ? "0" + dayString : dayString;

      var _todaylunarjson = calendar.solar2lunar(yearString, monthString, dayString);
      var _today = monthString + "月" + dayString + "日" + " " + _todaylunarjson.ncWeek;
      today = monthString + "-" + daysString;
      var _todaylunar = "农历" + _todaylunarjson.IMonthCn + _todaylunarjson.IDayCn;

      // 更新时间显示
      if (currentMode === "landscape") {
        if (showtime) {
          $("#time").hide();
          $("#day").show();
          $("#day").html(dayString);
        } else {
          $("#time").show();
          $("#day").hide();
          $("#time").html(timeString);
        }

        if ($("#monthday").html().indexOf(_today) !== 0) {
          $("#monthday").html(_today);
          $("#lunar").html(_todaylunar);
          loadData(yearString);
        }
      } else {
        if (showtime) {
          $("#time-portrait").hide();
          $("#day-portrait").show();
          $("#day-portrait").html(dayString);
        } else {
          $("#time-portrait").show();
          $("#day-portrait").hide();
          $("#time-portrait").html(timeString);
        }

        if ($("#monthday-portrait").html().indexOf(_today) !== 0) {
          $("#monthday-portrait").html(_today);
          $("#lunar-portrait").html(_todaylunar);
          loadData(yearString);
        }
      }

      setTimeout(function () {
        isImgLoad();
      }, 5000);
    }

    // 检查图片加载
    function isImgLoad() {
      if (currentMode === "landscape") {
        $("#image").each(function () {
          if (this.height < 50) {
            $("#image").attr("src", $("#image").attr("src"));
          }
        });
      } else {
        $("#backgroundImage").each(function () {
          if (this.height < 50) {
            var currentImg = $(this).css("background-image").replace(/url\("|"\)/g, "");
            $(this).css("background-image", "url(" + currentImg + ")");
          }
        });
      }
    }

    // 加载数据
    function loadData(yearString) {
      if (jsonfilename == null || jsonfilename === "") {
        jsonfilename = "DoubanAlbum" + yearString;
      }

      var json = "";
      if (typeof (Storage) !== "undefined") {
        json = localStorage.getItem(jsonfilename);
        if (json !== "" && json !== null) {
          setData(JSON.parse(json));
        } else {
          $.getScript("https://fastly.jsdelivr.net/gh/adyhwang/kindleclock/js/" + jsonfilename + ".js")
            .done(function () {
              localStorage.setItem(jsonfilename, JSON.stringify(jsonstr.list));
              setData(jsonstr.list);
            })
            .fail(function () {
              if (currentMode === "portrait") {
                $("#imagename").show();
              }
            });
        }
      } else {
        $.getScript("https://fastly.jsdelivr.net/gh/adyhwang/kindleclock/js/" + jsonfilename + ".js")
          .done(function () {
            setData(jsonstr.list);
          })
          .fail(function () {
            if (currentMode === "portrait") {
              $("#imagename").show();
            }
          });
      }
    }

    // 设置数据到界面
    function setData(json) {
      for (var key in json) {
        if (json[key].doubandate.indexOf(today) > -1) {
          var title = json[key].title;
          var rating = json[key].douban_rating;
          var director = json[key].director;
          var star = json[key].star;
          var year = json[key].year;
          var country = json[key].country;
          var genre = json[key].genre;
          var douban_link = "https://movie.douban.com/subject/" + json[key].douban_id;
          var quote = json[key].quote;
          var summary = json[key].summary;
          var image = "images/" + jsonfilename + "/" + today + ".jpg";

          if (currentMode === "landscape") {
            $("#title").html("《" + title + "》");
            $("#rating").html("豆瓣评分：" + rating);
            $("#director").html("导演：" + director);
            $("#star").html("主演：" + star);
            $("#year").html(year + " / " + country + " / " + genre);
            $("#quote").html("\"" + quote + "\"");
            $("#summary").html("剧情简介 · · · · · ·</br>　　" + summary);
            $("#image").attr("src", image);
            $("#mobile_qr").html("").qrcode({
              render: "canvas",
              width: 50,
              height: 50,
              text: douban_link
            });
            $("#mobile_qr").children("canvas").css("width", "100px");
            $("#mobile_qr").unbind("click").click(function () {
              window.open(douban_link, "_blank");
            });
          } else {
            $("#title-portrait").html("《" + title + "》");
            $("#rating-portrait").html("豆瓣评分：" + rating);
            $("#director-portrait").html("导演：" + director);
            $("#star-portrait").html("主演：" + star);
            $("#year-portrait").html(year + " / " + country + " / " + genre);
            $("#quote-portrait").html("\"" + quote + "\"");
            $("#summary-portrait").html("剧情简介 · · · · · ·</br>　　" + summary);
            $("#backgroundImage").css("background-image", "url(" + image + ")");
            $("#mobile_qr-portrait").html("").qrcode({
              render: "canvas",
              width: 50,
              height: 50,
              text: douban_link
            });
            $("#mobile_qr-portrait").children("canvas").css("width", "100px");
            $("#mobile_qr-portrait").unbind("click").click(function () {
              window.open(douban_link, "_blank");
            });
            $("#imagename").html(jsonfilename + "-" + today);
          }
          break;
        }
      }
    }

    // 切换时间/日期显示
    function showtimefunction() {
      showtime = !showtime;
      update();
    }

    // 切换更多信息显示
    function showmorefunction() {
      showmore = !showmore;
      if (currentMode === "landscape") {
        if (showmore) {
          $("#divleft").hide();
          $("#daytime").hide();
          $("#content").show();
          $("#quote").show();
          $("#star").show();
          $("#summary").show();
          $("#mobile_qr").show();
        } else {
          $("#divleft").show();
          $("#daytime").show();
          $("#quote").hide();
          $("#summary").hide();
          $("#star").hide();
          $("#mobile_qr").hide();
        }
      } else {
        if (showmore) {
          $("#bottomleft").hide();
          $("#bottomright").css("width", "");
          $("#quote-portrait").show();
          $("#summary-portrait").show();
          $("#star-portrait").show();
          $("#mobile_qr-portrait").show();
        } else {
          $("#bottomleft").show();
          $("#bottomright").css("width", "53%");
          $("#quote-portrait").hide();
          $("#summary-portrait").hide();
          $("#star-portrait").hide();
          $("#mobile_qr-portrait").hide();
        }
      }
    }

    // 输入日期
    function alertinput() {
      var input = prompt("请输入日期MMdd，如：2月15日输入0215");
      if (input && input.length === 4) {
        today = input.slice(0, 2) + "-" + input.slice(2);
        loadData(new Date().getFullYear());
      } else {
        alert("日期格式错误！请输入日期，如0215");
      }
    }

    // 绑定事件
    function bindEvents() {
      // 横屏事件
      $("#content").click(showmorefunction);
      $("#daytime").click(showtimefunction);
      $("#monthday").click(alertinput);

      // 竖屏事件
      $("#bottomright").click(showmorefunction);
      $("#daytime-portrait").click(showtimefunction);
      $("#monthday-portrait").click(alertinput);

      // 键盘事件
      $(document).keypress(function (e) {
        switch (e.keyCode) {
          case 100: // d
            showtimefunction();
            break;
          case 109: // m
            modefunction();
            break;
          case 115: // s
            showmorefunction();
            break;
          case 120: // x
          case 122: // z
            rotate = rotate ? 0 : 1;
            rotatefunction();
            break;
          default:
            break;
        }
      });
    }

    // 初始化
    initMode();
    initLayout();
    bindEvents();
    update();
    setInterval(update, 30000);
  </script>
</body>

</html>
